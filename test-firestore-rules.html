<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Rules Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; border-radius: 5px; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .info { background: #2d4a5a; }
        pre { background: #000; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Firestore Rules Test</h1>
    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        try {
            addResult('Testing Firestore rules with different access patterns...', 'info');
            
            // Import Firebase
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            const { initializeFirestore, collection, getDocs, query, limit } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyBqQqQqQqQqQqQqQqQqQqQqQqQqQqQqQqQ",
                authDomain: "jegodigital-2ed98.firebaseapp.com",
                projectId: "jegodigital-2ed98",
                storageBucket: "jegodigital-2ed98.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdefghijklmnopqrstuvwxyz"
            };
            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = initializeFirestore(app, {
                experimentalAutoDetectLongPolling: true,
                useFetchStreams: false,
            });
            
            addResult('Firebase initialized', 'success');
            
            // Test 1: Unauthenticated access
            addResult('Test 1: Trying to read without authentication...', 'info');
            try {
                const productsRef = collection(db, 'products');
                const q = query(productsRef, limit(1));
                const snapshot = await getDocs(q);
                addResult(`❌ Unexpected: Unauthenticated read succeeded! Found ${snapshot.docs.length} products`, 'error');
            } catch (error) {
                addResult(`✅ Expected: Unauthenticated read failed: ${error.message}`, 'success');
            }
            
            // Test 2: Authenticated access
            addResult('Test 2: Signing in anonymously and trying to read...', 'info');
            const user = await signInAnonymously(auth);
            addResult(`User signed in: ${user.user.uid}`, 'success');
            
            try {
                const productsRef = collection(db, 'products');
                const q = query(productsRef, limit(1));
                const snapshot = await getDocs(q);
                addResult(`✅ Authenticated read succeeded! Found ${snapshot.docs.length} products`, 'success');
                
                if (snapshot.docs.length > 0) {
                    const product = snapshot.docs[0].data();
                    addResult(`Sample product: ${JSON.stringify(product, null, 2)}`, 'info');
                }
            } catch (error) {
                addResult(`❌ Authenticated read failed: ${error.message}`, 'error');
                addResult(`Error code: ${error.code}`, 'error');
            }
            
            // Test 3: Check user claims
            addResult('Test 3: Checking user claims...', 'info');
            try {
                const tokenResult = await user.user.getIdTokenResult(true);
                addResult(`User claims: ${JSON.stringify(tokenResult.claims, null, 2)}`, 'info');
            } catch (error) {
                addResult(`Error getting claims: ${error.message}`, 'error');
            }
            
            addResult('Rules test completed!', 'info');
            
        } catch (error) {
            addResult(`❌ Error: ${error.message}`, 'error');
            addResult(`Stack trace: ${error.stack}`, 'error');
        }
    </script>
</body>
</html>
