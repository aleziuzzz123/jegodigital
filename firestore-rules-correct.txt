# CORRECT FIRESTORE RULES - FIXES BOTH AUTH AND CLAIMS ISSUES
# Copy and paste these rules in Firebase Console > Firestore > Rules
# These rules work for clients without requiring custom claims

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signed() { return request.auth != null; }
    function isAdmin() {
      return signed() && request.auth.token.role == 'admin';
    }
    // Treat as client if they either have the claim OR they own a clients/{uid} doc
    function isClient() {
      return signed() && (
        request.auth.token.role == 'client' ||
        exists(/databases/$(database)/documents/clients/$(request.auth.uid))
      );
    }

    // Catalog visible on the client dashboard
    match /products/{id} {
      allow read: if isClient() || isAdmin();
      allow write: if isAdmin();
    }
    match /bundles/{id} {
      allow read: if isClient() || isAdmin();
      allow write: if isAdmin();
    }

    // Client-owned data
    match /clients/{uid} {
      allow read, write: if isAdmin() || (isClient() && request.auth.uid == uid);
    }
    match /projects/{pid} {
      allow read, write: if isAdmin()
        || (isClient() && resource.data.clientId == request.auth.uid);
    }

    // Admin-only
    match /team/{id} { allow read, write: if isAdmin(); }
    match /payments/{id} { allow read, write: if isAdmin(); }
    match /support_tickets/{id} { allow read, write: if isAdmin(); }
    match /reports/{id} { allow read, write: if isAdmin(); }

    // Default deny
    match /{document=**} { allow read, write: if false; }
  }
}

# DIRECT LINKS:
# Firebase Console: https://console.firebase.google.com/u/6/project/jegodigital-2ed98/firestore/rules
# Test Page: https://jegodigital.com/test-comprehensive-fix.html
